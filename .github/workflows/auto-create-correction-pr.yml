name: Auto Create Correction PR

on:
  repository_dispatch:
    types: [user_correction_threshold_reached]

jobs:
  create-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install pg

      - name: Generate correction JSON
        env:
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
          TMDB_ID: ${{ github.event.client_payload.tmdb_id }}
          TITLE: ${{ github.event.client_payload.title }}
          SUGGESTED_START_YEAR: ${{ github.event.client_payload.suggested_start_year }}
          SUGGESTED_END_YEAR: ${{ github.event.client_payload.suggested_end_year }}
          SUGGESTED_PERIOD: ${{ github.event.client_payload.suggested_period }}
        run: node scripts/generate-correction-json.cjs

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: user-corrections/auto-${{ github.event.client_payload.tmdb_id }}-${{ github.run_number }}
          commit-message: |
            Apply user correction for "${{ github.event.client_payload.title }}"

            TMDb ID: ${{ github.event.client_payload.tmdb_id }}
            Suggested period: ${{ github.event.client_payload.suggested_period }}

            This correction was automatically approved based on 10+ unique user reports.
          title: 'ğŸ¬ User Correction: ${{ github.event.client_payload.title }}'
          body: |
            ## è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ä¿®æ­£ç”³å‘ŠPR

            ### æ˜ ç”»æƒ…å ±
            - **ã‚¿ã‚¤ãƒˆãƒ«**: ${{ github.event.client_payload.title }}
            - **TMDb ID**: ${{ github.event.client_payload.tmdb_id }}

            ### ææ¡ˆã•ã‚ŒãŸæ™‚ä»£è¨­å®š
            - **æ™‚ä»£**: ${{ github.event.client_payload.suggested_period }}
            - **é–‹å§‹å¹´**: ${{ github.event.client_payload.suggested_start_year || 'N/A' }}
            - **çµ‚äº†å¹´**: ${{ github.event.client_payload.suggested_end_year || 'N/A' }}

            ### æ‰¿èªç†ç”±
            ã“ã®ä¿®æ­£ã¯10äººä»¥ä¸Šã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰åŒã˜ææ¡ˆãŒã‚ã£ãŸãŸã‚ã€è‡ªå‹•çš„ã«æ‰¿èªã•ã‚Œã¾ã—ãŸã€‚

            ### ãƒ¬ãƒ“ãƒ¥ãƒ¼æ‰‹é †
            1. `.github/user-corrections.json`ã®å†…å®¹ã‚’ç¢ºèª
            2. å•é¡Œãªã‘ã‚Œã°ãƒãƒ¼ã‚¸
            3. ãƒãƒ¼ã‚¸ã™ã‚‹ã¨è‡ªå‹•çš„ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒæ›´æ–°ã•ã‚Œã¾ã™

            ---
            ğŸ¤– ã“ã®PRã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ
          labels: user-correction,auto-approved
