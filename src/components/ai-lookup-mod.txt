  const handleSelectMovie = async (tmdbMovie: TMDbMovie) => {
    setIsLoading(true);

    // ã‚¯ã‚¨ãƒªã«ã€Œ!ã€ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆAIæ¤œç´¢ãƒ•ãƒ©ã‚°ï¼‰
    const useAiLookup = query.includes('!');

    // è©³ç´°æƒ…å ±ã‚’å–å¾—
    const details = await getMovieDetails(tmdbMovie.id);

    if (details) {
      // æ™‚ä»£è¨­å®šã‚’æŠ½å‡º
      let timeline = extractTimePeriod(details);

      // æ™‚ä»£è¨­å®šãŒä¸æ˜Žã§ã€Œ!ã€ãƒžãƒ¼ã‚«ãƒ¼ãŒã‚ã‚‹å ´åˆã€AIæ¤œç´¢ã‚’å®Ÿè¡Œ
      if (useAiLookup && (timeline.startYear === null || timeline.isEstimated)) {
        console.log(`ðŸ¤– AI Lookup triggered by '!' marker for: ${details.title}`);
        const aiResult = await lookupAndCacheTimePeriod(details);
        
        if (aiResult) {
          // AIæ¤œç´¢çµæžœã‚’ä½¿ç”¨
          timeline = {
            startYear: aiResult.startYear,
            endYear: aiResult.endYear,
            period: aiResult.period,
            additionalYears: aiResult.additionalYears,
          };
          console.log(`âœ… AI Lookup successful: ${aiResult.period}`);
        }
      }

      // Movieåž‹ã«å¤‰æ›
      const movie: Movie = {
        id: `tmdb-${details.id}`,
        title: details.title,
        year: details.release_date
          ? parseInt(details.release_date.split('-')[0])
          : new Date().getFullYear(),
        posterUrl: getImageUrl(details.poster_path),
        timeline,
        genre: details.genres ? details.genres.map(g => g.name) : [],
        synopsis: details.overview,
      };

      onAddMovie(movie);
      setSearchResults([]);
      setQuery('');
    }

    setIsLoading(false);
  };
